---
title: 
author: 
date: 
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{css echo=FALSE}
p {
    font-family: "Open Sans"; 
    color: #444444;
}
```
<style>
.html-widget {
    margin: auto;
}
</style>

```{r, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, results='hide'}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
#install packages 
library(sf)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(kableExtra)
library(ggrepel)
library(formattable)
library(tmap)
library(extrafont)
library(mapboxapi)
font_import("C:/Users/GraceParker/Downloads/Open_Sans")

#insert data
territories <- st_read("C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/Territories/", quiet=TRUE)

#clean BIL data
targetF <- c("01","05","12","13","21","22","28","37","45","47","51","72","60","69","66","78")
targetG <- c(1,5,12,13,21,22,28,37,45,47,51,72,60,69,66,78)
targetH <- c("72","60","69","66","78")
SETerr <- dplyr::filter(territories,FIPS %in% targetF) #filter to SE and territories
# SEstates <- dplyr::filter(territories,FIPS %in% targetH) #filter to territories

#insert function/award type and population data by year
Asst2024_raw <- read.csv("C:/Users/GraceParker/Southeast Energy Efficiency Alliance Inc/Team SEEA - Documents/Research/Project_Files/2023_FederalFundingTracker/GitHubFolder/Data_01_22_2024/BILFY2~3/FY2024~3.CSV")
Con2024_raw <- read.csv("C:/Users/GraceParker/Southeast Energy Efficiency Alliance Inc/Team SEEA - Documents/Research/Project_Files/2023_FederalFundingTracker/GitHubFolder/Data_01_22_2024/BILFY2~3/FY2024~2.CSV")
Unl2024_raw <- read.csv("C:/Users/GraceParker/Southeast Energy Efficiency Alliance Inc/Team SEEA - Documents/Research/Project_Files/2023_FederalFundingTracker/GitHubFolder/Data_01_22_2024/BILFY2~3/FY2024~4.CSV")

Asst2023_raw <- read.csv("C:/Users/GraceParker/Southeast Energy Efficiency Alliance Inc/Team SEEA - Documents/Research/Project_Files/2023_FederalFundingTracker/GitHubFolder/Data_01_22_2024/BILFY2~2/FY2023~3.CSV")
Con2023_raw <- read.csv("C:/Users/GraceParker/Southeast Energy Efficiency Alliance Inc/Team SEEA - Documents/Research/Project_Files/2023_FederalFundingTracker/GitHubFolder/Data_01_22_2024/BILFY2~2/FY2023~2.CSV")
Unl2023_raw <- read.csv("C:/Users/GraceParker/Southeast Energy Efficiency Alliance Inc/Team SEEA - Documents/Research/Project_Files/2023_FederalFundingTracker/GitHubFolder/Data_01_22_2024/BILFY2~2/FY2023~4.CSV")

Asst2022_raw <- read.csv("C:/Users/GraceParker/Southeast Energy Efficiency Alliance Inc/Team SEEA - Documents/Research/Project_Files/2023_FederalFundingTracker/GitHubFolder/Data_01_22_2024/BILFY2~1/FY2022~3.CSV")
Con2022_raw <- read.csv("C:/Users/GraceParker/Southeast Energy Efficiency Alliance Inc/Team SEEA - Documents/Research/Project_Files/2023_FederalFundingTracker/GitHubFolder/Data_01_22_2024/BILFY2~1/FY2022~2.CSV")
Unl2022_raw <- read.csv("C:/Users/GraceParker/Southeast Energy Efficiency Alliance Inc/Team SEEA - Documents/Research/Project_Files/2023_FederalFundingTracker/GitHubFolder/Data_01_22_2024/BILFY2~1/FY2022~4.CSV")

#insert population data
pop2022_raw <- read.csv("C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/POP2022.csv")

#append data together
funData <- rbind(Asst2023_raw, Con2023_raw)
funData <- rbind(funData, Unl2023_raw)
funData <- rbind(funData, Asst2022_raw)
funData <- rbind(funData, Con2022_raw)
funData <- rbind(funData, Unl2022_raw)
funData <- rbind(funData, Asst2024_raw)
funData <- rbind(funData, Con2024_raw)
funData <- rbind(funData, Unl2024_raw)

#select
funData <- funData[!is.na(funData$transaction_obligated_amount),]
funData <-select(funData, budget_subfunction, awarding_agency_name, awarding_subagency_name, transaction_obligated_amount, recipient_state, recipient_county, award_type, recipient_name, program_activity_name, cfda_number, cfda_title)

#filter
targetE <- c("AL","AR","FL","GA","KY", "LA", "MS", "NC", "SC", "TN", "VA", "GU", "PR", "MP", "AS", "VI")
targetO <- c("GU", "PR", "MP", "AS", "VI")
funData <- dplyr::filter(funData, recipient_state %in% targetE)
DataTerr <- dplyr::filter(funData, recipient_state %in% targetO)

#group funding by territory/state
fundByState <- group_by(DataTerr, recipient_state) %>% dplyr::summarise(
  StateFunding = sum(transaction_obligated_amount))%>%
  as.data.frame()

colnames(fundByState)[1] <- "STATE"
#join shapefile to data for terr + states
BIL <- left_join(SETerr, fundByState, by = "STATE")

#Investigate negative values
# deoblig <- filter(funData, transaction_obligated_amount < 0)
# 
# deoblig1 <- deoblig %>%
#   group_by(recipient_state) %>% dplyr::summarise(
#   Funding = sum(transaction_obligated_amount)
#   )%>% as.data.frame()
# 
# deTot <- sum(deoblig1$Funding)
# 
# colnames(deoblig1)[1] <- "State"
# 

# deoblig1$Funding <- abs(deoblig1$Funding)
# deoblig1 <- deoblig1[order(deoblig1$Funding,decreasing=TRUE),]
# DeobTable<- deoblig1%>%select(State, Funding)%>% kbl(row.names=FALSE) %>%
#   kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, html_font="Calibri", font_size = 14, position="center", row_label_position = r)%>%
#   add_header_above(c("Deobligated Funding by State"=2))%>%
#   row_spec(1:11, color  = "black")%>%
#   column_spec(1:2, "3cm")
# DeobTable
# # 
# # save_kable(DeobTable,"C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/Deobtable.png")
# # 
# deobligPR <- deoblig %>% filter(recipient_state== "PR")%>%
#   group_by(budget_subfunction) %>% dplyr::summarise(
#   Funding = sum(transaction_obligated_amount)
#   )%>% as.data.frame()
# # 
# deobligPR2 <- deoblig %>% filter(recipient_state== "PR")%>%
#   group_by(award_type) %>% dplyr::summarise(
#   Funding = sum(transaction_obligated_amount)
#   )%>% as.data.frame()
# 
# deobligPR3 <- deoblig %>% filter(recipient_state== "PR")
# 
# 
# #By Category
# deoblig2 <- deoblig %>% 
#   group_by(budget_subfunction) %>% dplyr::summarise(
#   Funding = sum(transaction_obligated_amount)
#   )%>% as.data.frame()
# 
# deoblig2$Percent <- 100*(deoblig2$Funding/sum(deoblig2$Funding))
# deoblig2$Percent <- format(round(deoblig2$Percent, 2), nsmall=2)
# deoblig2$Percent <- as.numeric(deoblig2$Percent)
# 
# deoblig2$zone.start <- with(deoblig2, c(0, cumsum(Percent)[-length(Percent)]))  
# deoblig2$zone.end <- with(deoblig2, cumsum(Percent))  
# deoblig2$label.point <- with(deoblig2, (100-(zone.start + zone.end) / 2)) 
# 
# colnames(deoblig2)[1] <- "Category"
# 
# pie <- ggplot(deoblig2, aes(x="", y=Percent, fill=Category))+
#   geom_bar(width = 1, stat = "identity")+
#   coord_polar("y", start=0)+
#   scale_fill_manual(values=c("#FFA07A","#900C3F", "#C70039", "#D4442D", "#00869F", "#6171AF","#DCB6D0","#C799C8", "#D2D2D2", "#7B7B7B","#585757","#17202A")) +
#   geom_text_repel(data = deoblig2,
#                    aes(y = label.point, label = ifelse(Percent>5 | Category == 'Energy conservation' ,paste0(Percent, "%"),""), family="Open Sans"),
#                    size = 4.5, nudge_x = 1, show.legend = FALSE) +
#   ggtitle("Southeast Deobligated Funding by Category")+
#   theme_void(base_family= "Open Sans")+
#   theme(legend.key.height = unit(.5,'cm'),
#         legend.key.width = unit(.5, 'cm'))
# pie
# 
# ggsave("C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/Categories_Deob_SE.png", width = 6,   height = 4.25, dpi=1100)
# 
# #by Type
# deoblig3 <- deoblig %>% 
#   group_by(award_type) %>% 
#   dplyr::summarise(
#   Funding = sum(transaction_obligated_amount)
#   )%>% as.data.frame()
# 
# deoblig3$Percent <- 100*(deoblig3$Funding/sum(deoblig3$Funding))
# deoblig3$Percent <- format(round(deoblig3$Percent, 2), nsmall=2)
# deoblig3$Percent <- as.numeric(deoblig3$Percent)
# 
# deoblig3$zone.start <- with(deoblig3, c(0, cumsum(Percent)[-length(Percent)]))  
# deoblig3$zone.end <- with(deoblig3, cumsum(Percent))  
# deoblig3$label.point <- with(deoblig3, (100-(zone.start + zone.end) / 2)) 
# 
# colnames(deoblig3)[1] <- "Type"
# deoblig3$Type <- str_to_title(deoblig3$Type)
# deoblig3$Type[6] <- "Other Financial Assistance"
# deoblig3$Type[2] <- "Cooperative Agreement"
# deoblig3$Type[1] <- "BPA Call"
# deoblig3$Type[5] <- "Formula Grant"
# deoblig3$Type[7] <- "Project Grant"
# 
# pie <- ggplot(deoblig3, aes(x="", y=Percent, fill=Type))+
#   geom_bar(width = 1, stat = "identity")+
#   coord_polar("y", start=0)+
#   scale_fill_manual(values=c("#900C3F", "#D4442D", "#FCB616", "#75C7D3", "#00869F", "#C799C8", "#D2D2D2", "#585757")) +
#   geom_text_repel(data = deoblig3,
#                    aes(y = label.point, label = ifelse(Percent>5,paste0(Percent, "%"),""),family="Open Sans"),
#                    size = 4.5, nudge_x = 1, show.legend = FALSE, max.overlaps =20) +
#   ggtitle("Southeast Deobligated Funding by Award Type")+
#   theme_void(base_family= "Open Sans")+ 
#   theme(plot.title = element_text(size=12))
# pie

# totTerr <- sum(fundByState$StateFunding)
```

## Bipartisan Infrastructure Law Funding in the U.S. Territories

<div class = "row">
<div class = "col-md-8" style="padding-right:5px;">
```{r, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE}
BIL$StateFunding <- formattable::currency(BIL$StateFunding)

terrList <- c("Puerto Rico", "American Samoa", "Guam", "Northern Mariana Islands", "Virgin Islands (U.S.)")
terrFIPS <- c(60,66,69,72,78)
terr_pop <- read.csv("C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/Territories_pop/Territories_pop.csv")%>%
  select(Country.Name, X2022)%>%
  dplyr::filter(Country.Name %in% terrList)
# fundByTerr$Funding <- formattable::currency(fundByTerr$Funding, digits = 0L)
targetN <- c("AS","GU", "MP", "PR", "VI")
terr_pop$State <- c("AS","GU","MP","PR","VI")
colnames(fundByState)[1] <- "State"
terrData <- left_join(fundByState, terr_pop, by = "State")%>%
  dplyr::filter(State %in% targetN)
colnames(terrData)[3] <- "Territory"

gTarg <- c("COOPERATIVE AGREEMENT (B)","PROJECT GRANT (B)")
Grants_Terr <- dplyr::filter(funData, award_type %in% gTarg)%>%dplyr::filter(recipient_state %in% targetN)%>%
  group_by(recipient_state)%>%
  dplyr::summarise(Funding = sum(transaction_obligated_amount)) %>% 
  as.data.frame()

terrData$perCapita <- terrData$StateFunding/terrData$X2022
colnames(Grants_Terr)[1] <- "State"
terrData <- left_join(terrData,Grants_Terr, by="State")
terrData$GrantsPerCap = terrData$Funding/terrData$X2022
terrData$GrantsPerCap <- formattable::currency(terrData$GrantsPerCap, digits=0L)
terrData$Funding <- signif(as.numeric(terrData$Funding), 5)
terrData$Funding <- formattable::currency(terrData$Funding, digits=0L)

totTerr <- sum(terrData$StateFunding)
totPop <- sum(terrData$X2022)
perCap <- totTerr/totPop
 
terrData<- terrData%>% select(Territory, StateFunding, perCapita, Funding, GrantsPerCap) 
terrData <- terrData[order(terrData$StateFunding,decreasing=TRUE),]

# colnames(Grants_Terr)[1] <-"STATE"
TerrMap <- SETerr%>% filter(STATE%in% targetN)
colnames(TerrMap)[2] <- "Territory"
terrData$Territory[3] <- "U.S. Virgin Islands"
TerrMap$Territory[3] <- "U.S. Virgin Islands"
TerrGrantsMap <- left_join(TerrMap, terrData, by="Territory")
Total <-TerrGrantsMap
Grants <- TerrGrantsMap
#tmap PR
tmap_mode(mode ="view")
puerto <- tm_basemap("CartoDB.PositronNoLabels")+
tm_shape(Total) +
  tm_polygons("StateFunding",
      palette= c("#75C7D3", "#006A7E", "#00315E"),
      breaks=c(0, 50000000, 100000000, Inf),
      textNA= "$0",
      labels = c("$0-50 million", "$50-100 million", "$100 million+"),
      legend.position=c("right","bottom"),
      popup.vars= c("Funding: "="StateFunding"),
      popup.format= list(prefix="$", big.num.abbr=NA),
      id= "NAME",
      title= "Territory Funding",
      border.col="white")+
  tm_shape(Grants) +
  tm_polygons("Funding",
      palette= c("#75C7D3", "#006A7E", "#00315E"),
      breaks=c(0, 50000000, 100000000, Inf),
      textNA= "$0",
      labels = c("$0-50 million", "$50-100 million", "$100 million+"),
      legend.show=FALSE,
      popup.vars= c("Grants: "="Funding"),
      popup.format= list(prefix="$", big.num.abbr=NA),
      id= "STATE",
      title= "Grants Funding",
      border.col="white")+
tm_borders(col="white", lwd=.25)+
tmap_options(check.and.fix = TRUE)+
tm_view(set.view=c(-65.5,18,7))

#tmap GU
tmap_mode(mode ="view")
guam <- tm_basemap("CartoDB.PositronNoLabels")+
tm_shape(Total) +
  tm_polygons("StateFunding",
      palette= c("#75C7D3", "#006A7E", "#00315E"),
      breaks=c(0, 50000000, 100000000, Inf),
      textNA= "$0",
      labels = c("$0-50 million", "$50-100 million", "$100 million+"),
      legend.show=FALSE,
      popup.vars= c("Funding: "="StateFunding"),
      popup.format= list(prefix="$", big.num.abbr=NA),
      id= "NAME",
      title= "Territory Funding",
      border.col="white")+
  tm_shape(Grants) +
  tm_polygons("Funding",
      palette= c("#75C7D3", "#006A7E", "#00315E"),
      breaks=c(0, 30000000, 50000000, Inf),
      textNA= "$0",
      labels = c("$0-50 million", "$50-100 million", "$100 million+"),
      popup.vars= c("Grants: "="Funding"),
      popup.format= list(prefix="$", big.num.abbr=NA),
      id= "STATE",
      title= "Grant Funding",
      border.col="white")+
tm_borders(col="white", lwd=.25)+
tmap_options(check.and.fix = TRUE)+
tm_view(set.view=c(144.8,14,8))

#tmap AS
samoa <- tm_basemap("CartoDB.PositronNoLabels")+
tm_shape(Total) +
  tm_polygons("StateFunding",
      palette= c("#75C7D3", "#006A7E", "#00315E"),
      breaks=c(0, 50000000, 100000000, Inf),
      textNA= "$0",
      labels = c("$0-50,000,000", "$50,000,000-100,000,000", "$100,000,000+"),
      legend.show=FALSE,
      popup.vars= c("Funding: "="StateFunding"),
      popup.format= list(prefix="$", big.num.abbr=NA),
      id= "NAME",
      title= "Territory Funding",
      border.col="white")+
  tm_shape(Grants) +
  tm_polygons("Funding",
      palette= c("#75C7D3", "#006A7E", "#00315E"),
      breaks=c(0, 50000000, 100000000, Inf),
      textNA= "$0",
      labels = c("$0-50,000,000", "$50,000,000-100,000,000",
      "$100,000,000+"),
      legend.show=FALSE,
      popup.vars= c("Grants: "="Funding"),
      popup.format= list(prefix="$", big.num.abbr=NA),
      id= "STATE",
      title= "Grants Funding",
      border.col="white")+
tm_borders(col="white", lwd=.25)+
tmap_options(check.and.fix = TRUE)+
tm_view(set.view=c(-170,-14,7))

tmap_arrange(puerto, guam, samoa, nrow=1, ncol=3, widths=c(.25,.25,.25))

# BILterr <- BIL%>%filter(STATE %in% targetO)
# chartTerr <- left_join(BILterr,Grants_Terr, by="STATE")
# 
# chartTerr <- chartTerr[order(chartTerr$Funding,decreasing=TRUE),]%>%as.data.frame()%>%
#   select(STATE, Funding, perCapita, GrantFunding, perCapitaGrants)
# colnames(RegMap)[3] <-"Total Per Capita"
# colnames(RegMap)[4] <- "Grant Funding"
# colnames(RegMap)[5] <- "Grants Per Capita"
# RegionTable<- RegMap%>% kbl(row.names=FALSE) %>%
#   kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, html_font="Calibri", font_size = 14, position="center", row_label_position = r)%>%
#   add_header_above(c("Funding by Region"=5))%>%
#   row_spec(1:9, color  = "black")%>%
#   column_spec(1:5, "3cm")
# RegionTable
# 
# save_kable(RegionTable,"C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/Regiontable.png")
# 
# bbox_PR <- st_bbox(c(xmin = -67.7, xmax = -64.0, ymax = 19, ymin = 17.5), crs = st_crs(4326))
# 
# mbtiles <- get_static_tiles(
#   location = c(-67.55, 17.3, -63.85, 19.1),
#   zoom = 7,
#   style_url= "mapbox://styles/gparker-seea/clkr4hgj800zo01qk7npq3p0x",
#   username="gparker-seea",
#   access_token= "pk.eyJ1IjoiZ3Bhcmtlci1zZWVhIiwiYSI6ImNsa3I0ZHFtajJnc2QzcWtlajlmbWV3d2IifQ.jk6o3SXtTTAneVg11e_pww"
# )
# 
# tm_shape(mbtiles) +
#   tm_rgb() +
#   tm_shape(TerrGrantsMap) +
#   tm_polygons("Funding",
#           palette= c("#75C7D3", "#006A7E", "#00315E"),
#           breaks=c(0, 50000000, 100000000, Inf),
#           labels = c("$0-50 million", "$50-100 million", "$100 million+"),
#           textNA= "$0",
#           alpha=.85,
#       legend.show=FALSE,
#       border.col="white") +
#   tm_layout(legend.outside = TRUE)
# 
# tmap_save(filename="C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/puerto_grants_02_2024.png", dpi=1200)

# bbox_AS <- st_bbox(c(xmin = -171.2, xmax = -169.0, ymax = -13.9, ymin = -14.5), crs = st_crs(4326))
# 
# mbtiles <- get_static_tiles(
#   location = c(-171, -13.9, -169.3, -14.65),
#   zoom = 8,
#   style_url= "mapbox://styles/gparker-seea/clkr4hgj800zo01qk7npq3p0x",
#   username="gparker-seea",
#   access_token= "pk.eyJ1IjoiZ3Bhcmtlci1zZWVhIiwiYSI6ImNsa3I0ZHFtajJnc2QzcWtlajlmbWV3d2IifQ.jk6o3SXtTTAneVg11e_pww"
# )
# 
# tm_shape(mbtiles) +
#    tm_rgb() +
#    tm_shape(TerrGrantsMap) +
#    tm_polygons("Funding",
#            palette= c("#75C7D3", "#006A7E", "#00315E"),
#            breaks=c(0, 50000000, 100000000, Inf),
#            textNA= "$0",
#            alpha=.85,
#        legend.show=FALSE,
#        border.col="white")+
#    tm_layout(legend.outside = TRUE)
# 
# tmap_save(filename="C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/samoa_grants.png", dpi=1200)
# 
# 
# bbox_GU <- st_bbox(c(xmin = 144, xmax = 146.7, ymax = 15.4, ymin = 13), crs = st_crs(4326))
# mbtiles <- get_static_tiles(
#   location = c(145.05, 13.9, 145.85, 15.5),
#   zoom = 7,
#   style_url= "mapbox://styles/gparker-seea/clkr4hgj800zo01qk7npq3p0x",
#   username="gparker-seea",
#   access_token= "pk.eyJ1IjoiZ3Bhcmtlci1zZWVhIiwiYSI6ImNsa3I0ZHFtajJnc2QzcWtlajlmbWV3d2IifQ.jk6o3SXtTTAneVg11e_pww"
# )
# 
# tm_shape(mbtiles) +
#   tm_rgb() +
#   tm_shape(BIL) +
#   tm_polygons("StateFunding",
#           palette= c("#75C7D3", "#006A7E", "#00315E"),
#           breaks=c(0, 50000000, 100000000, Inf),
#           labels = c("$0-50,000,000", "$50-100 million", "$100 million+"),
#           textNA= "$0",
#           alpha=.85,
#       legend.show=FALSE,
#       border.col="white")
# 
# tmap_save(filename="C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/mariana.png", dpi=1200)

# mbtiles <- get_static_tiles(
#    location = c(144.4, 12.5, 145.2, 14.1),
#    zoom = 7,
#    style_url= "mapbox://styles/gparker-seea/clkr4hgj800zo01qk7npq3p0x",
#    username="gparker-seea",
#    access_token= "pk.eyJ1IjoiZ3Bhcmtlci1zZWVhIiwiYSI6ImNsa3I0ZHFtajJnc2QzcWtlajlmbWV3d2IifQ.jk6o3SXtTTAneVg11e_pww")
# 
#  tm_shape(mbtiles) +
#    tm_rgb() +
#    tm_shape(BIL) +
#    tm_polygons("StateFunding",
#            palette= c("#75C7D3", "#00869F", "#00315E"),
#            breaks=c(0, 50000000, 100000000, Inf),
#            labels = c("$0-50 million", "$50-100 million", "$100 million+"),
#            textNA= "$0",
#            alpha=.85,
#            title= "BIL Territory Funding",
#        # legend.show=FALSE,
#        border.col="white") +
#    tm_layout(legend.outside = TRUE, legend.outside.position="bottom", legend.text.fontfamily = "Calibri",
#        legend.title.fontfamily = "Calibri",
#        legend.title.size= 1,
#        legend.text.size=1)
# 
# tmap_save(filename="C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/guam_02_2024.png", dpi=1200)

```
</div>

<div class = "col-md-4">
<br>
The [Infrastructure Investment and Jobs Act](https://www.congress.gov/bill/117th-congress/house-bill/3684), also known as the Bipartisan Infrastructure Law (BIL), was passed in November 2021 and allocates $1.2 trillion over ten years in funding for infrastructure projects including roads, public transit, broadband, and electric grid upgrades. As federal agencies continue to allocate BIL funding, this map shows how much funding recipients in the U.S. Territories have received as of January 22, 2024. This dashboard focuses on funding available through the BIL, and we plan to address additional sources of funding, including the Inflation Reduction Act (IRA) in future versions of this whitepaper as more funding is allocated.
<br>
</div>

## {.tabset .tabset-row2}
### Funding by Territory 

```{css, echo=FALSE}
.nav-row2>li>a {
  background-color: #fff; /* Change "yourcolor" to the desired color value */
  color: #444444; /* Change the tab text color if needed */
}

.nav-row2>li.active>a,
.nav-row2>li.active>a:hover,
.nav-row2>li.active>a:focus {
  background-color: #75c7d3; /* Change "youractivecolor" to the desired active color value */
  color: #444444; /* Change the active tab text color if needed */
}
```
#### {.tabset .tabset-row2}
##### Overview
<div class = "row">
<div class = "col-md-7" style="padding-right:25px;">
``` {r echo=FALSE}
terrData$Percent <- 100*(as.numeric(terrData$StateFunding)/sum(as.numeric(terrData$StateFunding)))
terrData$Percent <- format(round(terrData$Percent, 2), nsmall=2)
terrData$Percent <- as.numeric(terrData$Percent)

terrData$zone.start <- with(terrData, c(0, cumsum(Percent)[-length(Percent)]))
terrData$zone.end <- with(terrData, cumsum(Percent))
terrData$label.point <- with(terrData, (((zone.start + zone.end) / 2)))
colnames(terrData)[1] <-"Territory"
pie <- ggplot(terrData, aes(x="", y=Percent, fill=reorder(Territory, Percent, decreasing=F)))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start=0)+
  scale_fill_manual(values=c("#900C3F", "#C70039", "#D4442D", "#FCB616","#FFF7B3"), name="Territories") +
  geom_text_repel(data = terrData,
                   aes(y = label.point, label = ifelse(Percent>5,paste0(Percent, "%"),""), family="Open Sans"),
                   size = 4.5, color="#444444", nudge_x = 1, show.legend = FALSE) +
  ggtitle("U.S. Territories Funding")+
  theme_void(base_family= "Open Sans")+
  theme(legend.key.height = unit(.5,'cm'),
        legend.key.width = unit(.5, 'cm'),
       legend.text=element_text(size=12, color="#444444"),
       plot.title = element_text(color = "#444444"),
       legend.title = element_text(color = "#444444"))
pie

terrData <- terrData[order(terrData$StateFunding,decreasing=TRUE),]
# SEdata$zone.start <- with(SEdata, c(0, cumsum(Percent)[-length(Percent)]))
# SEdata$zone.end <- with(SEdata, cumsum(Percent))
# SEdata$label.point <- with(SEdata, ((zone.start + zone.end) / 2))
# terrData$color <- c("#FFF7B3","#FCB616", "#D4442D", "#C70039", "#900C3F")
# terrData$label <- paste(terrData$Territory, terrData$Percent, "%", sep=" ")
# library(treemap)
# tm <- treemap(
#   dtf = terrData,
#   index = "label",
#   vSize = "StateFunding",
#   vColor = "color",
#   type = 'color', # {treemap}'s equivalent of scale_fill_identity() 
#   title="Puerto Rico Received Seven to Fourteen Times More Than Any Other Territory",
#   fontfamily.title= "Calibri",
#   fontfamily.labels= "Calibri",
#   border.col="white",
#   border.lwds=3
# )
# tm

```
</div>

<div class = "col-md-5">
``` {r echo=FALSE}

# terrData <-terrData%>%select(Territory, StateFunding, perCapita)
colnames(terrData)[2] <- "Funding" 
terrData$perCapita <- signif(as.numeric(terrData$perCapita), 5)
terrData$perCapita <- formattable::currency(terrData$perCapita, digits=0L)
colnames(terrData)[3] <- "Total Per Capita" 
terrData$Funding <- signif(as.numeric(terrData$Funding), 5)
terrData$Funding <- formattable::currency(terrData$Funding, digits=0L)

colnames(terrData)[4] <- "Grant Funding"
colnames(terrData)[5] <- "Grants Per Capita"
terrData <- terrData%>%select(1:5)
terrTable<- terrData%>% kbl(row.names=FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, html_font="Open Sans", font_size = 14, position="center", row_label_position = r)%>%
  add_header_above(c("Funding by Territory"=5))%>%
  row_spec(1:5, color  = "#444444")%>%
  column_spec(1:5, "4cm")
terrTable
# save_kable(terrTable,"C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/Terrtable_02_2024.png")

```
</div>

##### American Samoa
<div class = "row">
<div class = "col-md-7" style="padding-right:25px;">
```{r, echo=FALSE, fig.align='center'}
#function and award type data, filter to American Samoa
funcAS <-dplyr::filter(funData, recipient_state=="AS")%>%
  group_by(budget_subfunction) %>% dplyr::summarise(
  Funding = sum(transaction_obligated_amount)
  )%>% as.data.frame()

funcAS$Percent <- 100*(funcAS$Funding/sum(funcAS$Funding))
funcAS$Percent <- format(round(funcAS$Percent, 2), nsmall=2)
funcAS$Percent <- as.numeric(funcAS$Percent)

funcAS$zone.start <- with(funcAS, c(0, cumsum(Percent)[-length(Percent)]))  
funcAS$zone.end <- with(funcAS, cumsum(Percent))  
funcAS$label.point <- with(funcAS, (100-(zone.start + zone.end) / 2)) 

colnames(funcAS)[1] <- "Category"

pie <- ggplot(funcAS, aes(x="", y=Percent, fill=Category))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start=0)+
  scale_fill_manual(values=c("#900C3F","#C70039", "#D4442D", "#FFF7B3","#00869F", "#6171AF","#DCB6D0","#C799C8","#D2D2D2","#7B7B7B")) +
  geom_text_repel(data = funcAS,
                   aes(y = label.point, label = ifelse(Percent>10,paste0(Percent, "%"),""), family="Open Sans"),
                   size = 4.5, color="#444444", nudge_x = 1, show.legend = FALSE)+
  ggtitle("American Samoa Funding")+
  theme_void(base_family = "Open Sans")+
    theme(legend.text=element_text(size=12, color="#444444"), 
       plot.title = element_text(color = "#444444"), 
       legend.title = element_text(color = "#444444"))
pie
# ggsave("C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/AmericanSam_cat.png", width = 6,   height = 4.25, dpi=1100)

```
</div>

<div class = "col-md-5">
``` {r echo=FALSE}
funcAS$Funding <- signif(funcAS$Funding, 5)
funcAS$Funding <- currency(funcAS$Funding, digits = 0L)
funcAS%>% select(Category, Funding)%>% kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, html_font="Open Sans", font_size = 14)%>%  
  add_header_above(c("American Samoa Funding by Category"=2))%>%
  row_spec(1:8, color  = "#444444")%>%
  column_spec(1, "10cm")%>%
  column_spec(2, "3cm")
```
</div>
</div>
<div class = "row">
<br>
<br>
<br>
</div>
<h4>Spotlight on Projects</h4>
American Samoa Government Department of Commerce: The National Oceanic and Atmospheric Administration committed $203,000 to American Samoa for wetland delineation, wetland monitoring, training, and community outreach, as well as to create recommendations for permitting policies and nature-based restoration projects. 

##### Guam
<div class = "row">
<div class = "col-md-7" style="padding-right:25px;">
```{r, echo=FALSE, fig.align='center'}
#function and award type data, filter to GUAM
funcGU <-dplyr::filter(funData, recipient_state=="GU")%>%
  group_by(budget_subfunction) %>% dplyr::summarise(
  Funding = sum(transaction_obligated_amount)
  )%>% as.data.frame()

funcGU$Percent <- 100*(funcGU$Funding/sum(funcGU$Funding))
funcGU$Percent <- format(round(funcGU$Percent, 2), nsmall=2)
funcGU$Percent <- as.numeric(funcGU$Percent)

funcGU$zone.start <- with(funcGU, c(0, cumsum(Percent)[-length(Percent)]))  
funcGU$zone.end <- with(funcGU, cumsum(Percent))  
funcGU$label.point <- with(funcGU, (100-(zone.start + zone.end) / 2)) 

colnames(funcGU)[1] <- "Category"

pie <- ggplot(funcGU, aes(x="", y=Percent, fill=Category))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start=0)+
  scale_fill_manual(values=c("#900C3F","#C70039", "#D4442D", "#00869F", "#6171AF","#DCB6D0","#C799C8","#D2D2D2","#7B7B7B","#000000")) +
  geom_text_repel(data = funcGU,
                   aes(y = label.point, label = ifelse(Percent>10,paste0(Percent, "%"),""), family="Open Sans"),
                   size = 4.5, color= "#444444", nudge_x = 1, show.legend = FALSE)+
  ggtitle("Guam Funding")+
  theme_void(base_family = "Open Sans")+
  theme(legend.text=element_text(size=12, color="#444444"), 
       plot.title = element_text(color = "#444444"), 
       legend.title = element_text(color = "#444444"))
pie

# ggsave("C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/Guam_cat.png", width = 6,   height = 4.25, dpi=1100)
```
</div>
<div class = "col-md-5">

``` {r echo=FALSE}

funcGU$Funding <- signif(funcGU$Funding, 5)
funcGU$Funding <- currency(funcGU$Funding, digits = 0L)
funcGU%>% select(Category, Funding)%>% kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, html_font="Open Sans", font_size = 14)%>%  
  add_header_above(c("Guam Funding by Category"=2))%>%
  row_spec(1:8, color  = "#444444")%>%
  column_spec(1, "10cm")%>%
  column_spec(2, "3cm")
```
</div>
</div>
<div class = "row">
<br>
<br>
<br>
</div>
<h4>Spotlight on Projects</h4>
Teleguam Holdings: The Department of Agriculture committed $29 million to Teleguam Holdings to provide internet connection to 8,000 households in Guam.

##### Northern Mariana Islands
<div class = "row">
<div class = "col-md-7" style="padding-right:25px;">
```{r, echo=FALSE, fig.align='center'}
#function and award type data, filter to Northern Mariana Islands
funcMP <-dplyr::filter(funData, recipient_state=="MP")%>%
  group_by(budget_subfunction) %>% dplyr::summarise(
  Funding = sum(transaction_obligated_amount)
  )%>% as.data.frame()

funcMP$Percent <- 100*(funcMP$Funding/sum(funcMP$Funding))
funcMP$Percent <- format(round(funcMP$Percent, 2), nsmall=2)
funcMP$Percent <- as.numeric(funcMP$Percent)

funcMP$zone.start <- with(funcMP, c(0, cumsum(Percent)[-length(Percent)]))  
funcMP$zone.end <- with(funcMP, cumsum(Percent))  
funcMP$label.point <- with(funcMP, (100-(zone.start + zone.end) / 2)) 

colnames(funcMP)[1] <- "Category"

pie <- ggplot(funcMP, aes(x="", y=Percent, fill=Category))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start=0)+
  scale_fill_manual(values=c("#FFA07A","#900C3F","#C70039", "#D4442D", "#00869F", "#6171AF","#DCB6D0","#C799C8","#7B7B7B")) +
  geom_text_repel(data = funcMP,
                   aes(y = label.point, label = ifelse(Percent>10,paste0(Percent, "%"),""), family="Open Sans"),
                   size = 4.5, color="#444444", nudge_x = 1, show.legend = FALSE)+
  ggtitle("Northern Mariana Islands Funding")+
  theme_void(base_family = "Open Sans")+
  theme(legend.text=element_text(size=12, color="#444444"), 
       plot.title = element_text(color = "#444444"), 
       legend.title = element_text(color = "#444444"))
pie

# ggsave("C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/Mariana_cat.png", width = 6,   height = 4.25, dpi=1100)

```
</div>
<div class = "col-md-5">
``` {r echo=FALSE}
funcMP$Funding <- signif(funcMP$Funding, 5)
funcMP$Funding <- currency(funcMP$Funding, digits = 0L)
funcMP%>% select(Category, Funding)%>% kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, html_font="Open Sans", font_size = 14)%>%  
  add_header_above(c("Northern Mariana Islands Funding by Category"=2))%>%
  row_spec(1:8, color  = "#444444")%>%
  column_spec(1, "10cm")%>%
  column_spec(2, "3cm")
```
</div>
</div>
<div class = "row">
<br>
<br>
<br>
</div>

<h4>Spotlight on Projects</h4>
Commonwealth Utilities Corporation: The Environmental Protection Agency committed $20.6 million to improve the drinking water system on the Northern Mariana Islands, including by replacing and upgrading water mains and pressurizing the transmission and distribution system. These projects will aid in providing reliable, potable drinking water to every customer.

##### Puerto Rico
<div class = "row">
<div class = "col-md-7" style="padding-right:25px;">
```{r, echo=FALSE, fig.align='center'}
#function and award type data, filter to Puerto Rico
funcPR <-dplyr::filter(funData, recipient_state=="PR")%>%
  group_by(budget_subfunction) %>% dplyr::summarise(
  Funding = sum(transaction_obligated_amount)
  )%>% as.data.frame()

funcPR$Percent <- 100*(funcPR$Funding/sum(funcPR$Funding))
funcPR$Percent <- format(round(funcPR$Percent, 2), nsmall=2)
funcPR$Percent <- as.numeric(funcPR$Percent)

funcPR$zone.start <- with(funcPR, c(0, cumsum(Percent)[-length(Percent)]))  
funcPR$zone.end <- with(funcPR, cumsum(Percent))  
funcPR$label.point <- with(funcPR, (100-(zone.start + zone.end) / 2)) 

colnames(funcPR)[1] <- "Category"

pie <- ggplot(funcPR, aes(x="", y=Percent, fill=Category))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start=0)+
  scale_fill_manual(values=c("#FFA07A","#900C3F", "#C70039", "#D4442D", "#FFF7B3","#00869F", "#6171AF","#DCB6D0","#C799C8", "#7B7B7B","#585757","#17202A")) +
  geom_text_repel(data = funcPR,
                   aes(y = label.point, label = ifelse(Percent>10,paste0(Percent, "%"),""), family="Open Sans"),
                   size = 4.5, color="#444444", nudge_x = 1, show.legend = FALSE)+
  ggtitle("Ground Transportation is the Largest Category in Puerto Rico")+
  theme_void(base_family = "Open Sans")+
  theme(legend.text=element_text(size=10, color="#444444"), 
       plot.title = element_text(color = "#444444"), 
       legend.title = element_text(color = "#444444"))
pie

# ggsave("C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/PuertoRico_cat.png", width = 6,   height = 4.25, dpi=1100)

```
</div>
<div class = "col-md-5">

``` {r echo=FALSE}
funcPR$Funding <- signif(funcPR$Funding, 5)
funcPR$Funding <- currency(funcPR$Funding, digits = 0L)
funcPR%>% select(Category, Funding)%>% kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, html_font="Open Sans", font_size = 14)%>%  
  add_header_above(c("Puerto Rico Funding by Category"=2))%>%
  row_spec(1:8, color  = "#444444")%>%
  column_spec(1, "10cm")%>%
  column_spec(2, "3cm")
```
</div>
<h4>Spotlight on Projects</h4>
Institute for Socio-Ecological Research: The Department of Commerce will commit $10.6 million to construct five acres of coral reef at three locations in Puerto Rico. The project will reintroduce slow-growing, reef-building coral species, including threatened species. 

##### Virgin Islands
<div class = "row">
<div class = "col-md-7" style="padding-right:25px;">
```{r, echo=FALSE, fig.align='center'}
#function and award type data, filter to Virgin Islands
funcVI <-dplyr::filter(funData, recipient_state=="VI")%>%
  group_by(budget_subfunction) %>% dplyr::summarise(
  Funding = sum(transaction_obligated_amount)
  )%>% as.data.frame()

funcVI$Percent <- 100*(funcVI$Funding/sum(funcVI$Funding))
funcVI$Percent <- format(round(funcVI$Percent, 2), nsmall=2)
funcVI$Percent <- as.numeric(funcVI$Percent)

funcVI$zone.start <- with(funcVI, c(0, cumsum(Percent)[-length(Percent)]))  
funcVI$zone.end <- with(funcVI, cumsum(Percent))  
funcVI$label.point <- with(funcVI, (100-(zone.start + zone.end) / 2)) 

colnames(funcVI)[1] <- "Category"

pie <- ggplot(funcVI, aes(x="", y=Percent, fill=Category))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start=0)+
  scale_fill_manual(values=c("#FFA07A","#900C3F", "#C70039", "#D4442D","#FFF7B3","#00869F", "#6171AF","#DCB6D0","#C799C8", "#7B7B7B","#585757")) +
  geom_text_repel(data = funcVI,
                   aes(y = label.point, label = ifelse(Percent>10,paste0(Percent, "%"),""), family="Open Sans"),
                   size = 4.5, color="#444444", nudge_x = 1, show.legend = FALSE)+
  ggtitle("Virgin Islands")+
  theme_void(base_family = "Open Sans")+
  theme(legend.text=element_text(size=12, color="#444444"), 
       plot.title = element_text(color = "#444444"), 
       legend.title = element_text(color = "#444444"))
pie

# ggsave("C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/VirginIs_cat.png", width = 6,   height = 4.25, dpi=1100)

```

</div>
<div class = "col-md-5">
``` {r echo=FALSE}
funcVI$Funding <- signif(funcVI$Funding, 5)
funcVI$Funding <- currency(funcVI$Funding, digits = 0L)
funcVI%>% select(Category, Funding)%>% kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, html_font="Open Sans", font_size = 14)%>%  
  add_header_above(c("U.S. Virgin Islands Funding by Category"=2))%>%
  row_spec(1:8, color  = "#444444")%>%
  column_spec(1, "10cm")%>%
  column_spec(2, "3cm")
```
</div>
<div class = "row">
<br>
<br>
<br>
</div>

<h4>Spotlight on Projects</h4>
Island Conservation: The Department of Interior committed $250,000 to Island Conservation to aid in invasive species eradication and create a refuge for the endangered Virgin Islands tree boa.

### Funding by Category
<div class = "row">
<div class = "col-md-7" style="padding-right:25px;">
``` {r echo=FALSE, fig.align='center'}
funcTerr <- funData %>% dplyr::filter(recipient_state %in% targetN)%>%
  group_by(budget_subfunction) %>% dplyr::summarise(
  Funding = sum(transaction_obligated_amount)
  )%>% as.data.frame()

funcTerr$Percent <- 100*(funcTerr$Funding/sum(funcTerr$Funding))
funcTerr$Percent <- format(round(funcTerr$Percent, 2), nsmall=2)
funcTerr$Percent <- as.numeric(funcTerr$Percent)

funcTerr$zone.start <- with(funcTerr, c(0, cumsum(Percent)[-length(Percent)]))  
funcTerr$zone.end <- with(funcTerr, cumsum(Percent))  
funcTerr$label.point <- with(funcTerr, (100-(zone.start + zone.end) / 2)) 

colnames(funcTerr)[1] <- "Category"

pie <- ggplot(funcTerr, aes(x="", y=Percent, fill=Category))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start=0)+
  scale_fill_manual(values=c("#FFA07A","#900C3F", "#C70039", "#D4442D","#FFF7B3", "#00869F", "#6171AF","#DCB6D0","#C799C8", "#D2D2D2", "#7B7B7B","#585757","#17202A")) +
  geom_text_repel(data = funcTerr,
                   aes(y = label.point, label = ifelse(Percent>5 | Category == 'Energy conservation' ,paste0(Percent, "%"),""), family="Open Sans"),
                   size = 4.5, color= "#444444", nudge_x = 1, show.legend = FALSE) +
  ggtitle("U.S. Territories Funding by Category")+
  theme_void(base_family= "Open Sans")+
  theme(legend.key.height = unit(.5,'cm'),
        legend.key.width = unit(.5, 'cm'),
        legend.text=element_text(size=12, color="#444444"), 
       plot.title = element_text(color = "#444444"), 
       legend.title = element_text(color = "#444444"))
pie

# ggsave("C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/Categories_Terr.png", width = 6,   height = 4.25, dpi=1100)
```
</div>

<div class = "col-md-5">
``` {r echo=FALSE}
funcTerr$Funding <- signif(funcTerr$Funding, 5)
funcTerr$Funding <- formattable::currency(funcTerr$Funding, digits = 0L)
terrFuncTable <-funcTerr%>%select(Category, Funding)%>%kbl(row.names=FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, html_font="Open Sans", font_size = 14, position="center", row_label_position = r)%>%
  add_header_above(c("Territory Funding by Category"=2))%>%
  row_spec(1:5, color  = "#444444")%>%
  column_spec(1:2, "4cm")
terrFuncTable
# save_kable(terrFuncTable,"C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/TerrFunctable.png")
```
</div>

### Funding by Award Type
<div class = "row">
<div class = "col-md-7" style="padding-right:25px;">
``` {r echo=FALSE}
fundByType_Terr <- funData %>% dplyr::filter(recipient_state %in% targetN)%>%
  group_by(award_type) %>% 
  dplyr::summarise(
  Funding = sum(transaction_obligated_amount)
  )%>% as.data.frame()

fundByType_Terr$Percent <- 100*(fundByType_Terr$Funding/sum(fundByType_Terr$Funding))
fundByType_Terr$Percent <- format(round(fundByType_Terr$Percent, 2), nsmall=2)
fundByType_Terr$Percent <- as.numeric(fundByType_Terr$Percent)

fundByType_Terr$zone.start <- with(fundByType_Terr, c(0, cumsum(Percent)[-length(Percent)]))  
fundByType_Terr$zone.end <- with(fundByType_Terr, cumsum(Percent))  
fundByType_Terr$label.point <- with(fundByType_Terr, (100-(zone.start + zone.end) / 2)) 

colnames(fundByType_Terr)[1] <- "Type"
fundByType_Terr$Type <- str_to_title(fundByType_Terr$Type)
fundByType_Terr$Type[5] <- "Direct Payment Specified Use"
fundByType_Terr$Type[7] <- "Other Financial Assistance"
fundByType_Terr$Type[1] <- "Block Grant"
fundByType_Terr$Type[2] <- "Cooperative Agreement"
fundByType_Terr$Type[6] <- "Formula Grant"
fundByType_Terr$Type[8] <- "Project Grant"

pie <- ggplot(fundByType_Terr, aes(x="", y=Percent, fill=Type))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start=0)+
  scale_fill_manual(values=c("#900C3F", "#D4442D", "#FCB616", "#52BE80","#75C7D3", "#00869F", "#C799C8", "#D2D2D2", "#585757")) +
  geom_text_repel(data = fundByType_Terr,
                   aes(y = label.point, label = ifelse(Percent>5,paste0(Percent, "%"),""),family="Open Sans"),
                   size = 4.5, color="#444444", nudge_x = 1, show.legend = FALSE, max.overlaps =20) +
  ggtitle("Grants are the Primary Source of Funding in the Territories")+
  theme_void(base_family= "Open Sans")+ 
  theme(plot.title = element_text(size=12, color="#444444"),
       legend.text=element_text(size=12, color="#444444"), 
       legend.title = element_text(color = "#444444"))
pie

# ggsave("C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/award_type_02_2024.png", width = 6,   height = 4, dpi=1100)

# TerrCA<- funData%>% filter(recipient_state %in% targetN)%>%
#   filter(award_type=="COOPERATIVE AGREEMENT (B)")
TerrDP<- funData%>% filter(recipient_state %in% targetN)%>%
  filter(award_type=="DIRECT PAYMENT FOR SPECIFIED USE, AS A SUBSIDY OR OTHER NON-REIMBURSABLE DIRECT FINANCIAL AID (C)")
fundByType_Terr_noPR <- funData %>% dplyr::filter(recipient_state %in% targetN)%>%
  filter(recipient_state!="PR")%>%
  group_by(budget_subfunction) %>% 
  dplyr::summarise(
  Funding = sum(transaction_obligated_amount)
  )%>% as.data.frame()

fundByType_Terr_noPR$Percent <- 100*(fundByType_Terr_noPR$Funding/sum(fundByType_Terr_noPR$Funding))
fundByType_Terr_noPR$Percent <- format(round(fundByType_Terr_noPR$Percent, 2), nsmall=2)
fundByType_Terr_noPR$Percent <- as.numeric(fundByType_Terr_noPR$Percent)

fundByType_Terr_noPR$zone.start <- with(fundByType_Terr_noPR, c(0, cumsum(Percent)[-length(Percent)]))  
fundByType_Terr_noPR$zone.end <- with(fundByType_Terr_noPR, cumsum(Percent))  
fundByType_Terr_noPR$label.point <- with(fundByType_Terr_noPR, (100-(zone.start + zone.end) / 2)) 

colnames(fundByType_Terr_noPR)[1] <- "Category"

pie <- ggplot(fundByType_Terr_noPR, aes(x="", y=Percent, fill=Category))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start=0)+
  scale_fill_manual(values=c("#FFA07A","#900C3F", "#C70039", "#D4442D","#FFF7B3", "#00869F", "#6171AF","#DCB6D0","#C799C8", "#D2D2D2", "#7B7B7B","#585757","#17202A")) +
  geom_text_repel(data = fundByType_Terr_noPR,
                   aes(y = label.point, label = ifelse(Percent>5,paste0(Percent, "%"),""),family="Open Sans"),
                   size = 4.5, color="#444444", nudge_x = 1, show.legend = FALSE, max.overlaps =20) +
  ggtitle("Pollution Control is the Largest Category among American Samoa,\nthe Northern Mariana Islands, Guam, and the Virgin Islands")+
  theme_void(base_family= "Open Sans")+ 
  theme(plot.title = element_text(size=12, color="#444444"),
       legend.text=element_text(size=10, color="#444444"), 
       legend.title = element_text(color = "#444444"))
pie

# ggsave("C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/categories_nopR.png", width = 6,   height = 4, dpi=1100)
```
</div>

<div class = "col-md-5">
``` {r echo=FALSE}
fundByType_Terr$Funding <- signif(fundByType_Terr$Funding, 5)
fundByType_Terr$Funding <- formattable::currency(fundByType_Terr$Funding, digits = 0L)
terrTypeTable <-fundByType_Terr%>%select(Type, Funding)%>%kbl(row.names=FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, html_font="Open Sans", font_size = 14, position="center", row_label_position = r)%>%
  add_header_above(c("Territory Funding by Type"=2))%>%
  row_spec(1:5, color  = "#444444")%>%
  column_spec(1:2, "4cm")
terrTypeTable
# save_kable(terrTypeTable,"C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/terrTypeTable.png")
```
</div>

### Energy Funding
<div class = "row">
<div class = "col-md-6" style="padding-right:20px;">
``` {r echo=FALSE}
###Weatherization Assistance Program Funding TERRITORIES
WAPdata <- funData %>%select(transaction_obligated_amount, program_activity_name, recipient_name, cfda_number, cfda_title, recipient_state)%>%filter(cfda_number == 81.042)%>%
  filter(recipient_state %in% targetO)%>%
  group_by(recipient_name)%>%
  dplyr::summarise(Funding = sum(transaction_obligated_amount))
  
colnames(WAPdata)[2] <- "Funding"
colnames(WAPdata)[1] <- "Recipient"
WAPdata$Recipient <- paste(str_to_title(WAPdata$Recipient))
WAPdata$Funding <- signif(WAPdata$Funding, 5)
WAPdata$Funding <- currency(WAPdata$Funding, digits = 0L)
WAPdata <- WAPdata[order(WAPdata$Funding,decreasing=TRUE),]
WAPdata$Recipient[1] <- "Departamento De Desarrollo Economico Y Comercio (Puerto Rico)"
WAPdata$Recipient[5] <- "U.S. Virgin Islands Office of the Governor"

WAPtable<- WAPdata%>% select(Recipient, Funding)%>% kbl(row.names=FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, html_font="Open Sans", font_size = 14)%>%  
  add_header_above(c("Weatherization Assistance Program Funding"=2))%>%
  row_spec(1:5, color  = "#444444")
  # column_spec(1, "12cm")%>%
  # column_spec(2, "3cm")
WAPtable
###

# save_kable(WAPtable,"C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/WAPtable_terr_02_2024.png")
WAPtotal_terr <- sum(WAPdata$Funding)
```
</div>

<div class = "col-md-6">
```{r, echo=FALSE, fig.align='center'}
###State Energy Office Funding TERRITORIES
SEOdata <- funData%>%select(transaction_obligated_amount, program_activity_name, recipient_name, cfda_number, recipient_state)%>%filter(cfda_number == 81.041)%>%
  filter(recipient_state %in% targetO)%>%
  group_by(recipient_name)%>%
  dplyr::summarise(Funding = sum(transaction_obligated_amount))

colnames(SEOdata)[2] <- "Funding"
colnames(SEOdata)[1] <- "Recipient"
SEOdata$Recipient <- paste(str_to_title(SEOdata$Recipient))
SEOdata$Funding <- signif(SEOdata$Funding, 5)
SEOdata$Funding <- currency(SEOdata$Funding, digits = 0L)
SEOdata <- SEOdata[order(SEOdata$Funding,decreasing=TRUE),]
SEOdata$Recipient[1] <- "Departamento De Desarrollo Economico Y Comercio (Puerto Rico)"
SEOdata$Recipient[3] <- "U.S. Virgin Islands Office of the Governor"
SEOtable<-SEOdata%>% select(Recipient, Funding)%>% kbl(row.names=FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), html_font="Open Sans", font_size = 14, full_width = F)%>%
  add_header_above(c("State Energy Program Funding"=2))%>%
  row_spec(1:5, color  = "#444444")
  # column_spec(1, "12cm")%>%
  # column_spec(2, "3cm")
SEOtable

# save_kable(SEOtable,"C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/SEOtable_terr_02_2024.png")
SEOtotal_terr <- sum(SEOdata$Funding)

# #function and award type data, filter to Territories minus PR
# funcTerr <-dplyr::filter(funData, recipient_state=="AS"|recipient_state=="MP"|recipient_state=="GU"|recipient_state=="VI")%>%
#   group_by(budget_subfunction) %>% dplyr::summarise(
#   Funding = sum(transaction_obligated_amount)
#   )%>% as.data.frame()
# 
# funcTerr$Percent <- 100*(funcTerr$Funding/sum(funcTerr$Funding))
# funcTerr$Percent <- format(round(funcTerr$Percent, 2), nsmall=2)
# funcTerr$Percent <- as.numeric(funcTerr$Percent)
# 
# funcTerr$zone.start <- with(funcTerr, c(0, cumsum(Percent)[-length(Percent)]))  
# funcTerr$zone.end <- with(funcTerr, cumsum(Percent))  
# funcTerr$label.point <- with(funcTerr, (100-(zone.start + zone.end) / 2)) 
# 
# colnames(funcTerr)[1] <- "Category"
# 
# pie <- ggplot(funcTerr, aes(x="", y=Percent, fill=Category))+
#   geom_bar(width = 1, stat = "identity")+
#   coord_polar("y", start=0)+
#   scale_fill_manual(values=c("#FFA07A","#900C3F","#C70039", "#D4442D", "#00869F", "#6171AF","#DCB6D0","#C799C8","#7B7B7B","#585757")) +
#   geom_text_repel(data = funcTerr,
#                    aes(y = label.point, label = ifelse(Percent>10,paste0(Percent, "%"),""), family="Open Sans"),
#                    size = 4.5, nudge_x = 1, show.legend = FALSE)+
#   ggtitle("American Samoa, Guam, Northern Mariana Islands, and Virgin Islands")+
#   theme_void(base_family = "Open Sans")
# pie
# ggsave("C:/Users/GraceParker/Downloads/2023_FederalFundingTracker/FuncTerr_cat.png", width = 6,   height = 4.25, dpi=1100)

```
</div>
